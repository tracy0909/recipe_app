{% extends 'base.html' %}
{% import '_macros.html' as m %}
{% block title %}æ‰€æœ‰é£Ÿè­œ{% endblock %}
{% block content %}
<!-- <section class="hero pro">
  <h1>é–‹å§‹å»ºç«‹èˆ‡ç®¡ç†æ‚¨çš„å°ˆå±¬é£Ÿè­œ</h1>
  <p class="muted">æ•´ç†éˆæ„Ÿã€ç®¡ç†é£Ÿæã€è¨˜éŒ„æ­¥é©Ÿï¼Œæ‰“é€ ä½ çš„æ–™ç†çŸ¥è­˜åº«ã€‚</p>
  <div class="cta">
    {% if current_user.is_authenticated %}
      <a class="button primary" href="{{ url_for('recipes.new') }}">+ æ–°å¢é£Ÿè­œ</a>
      <a class="button" href="{{ url_for('recipes.index') }}">æ‰€æœ‰é£Ÿè­œ</a>
    {% else %}
      <a class="button primary" href="{{ url_for('auth.register') }}">è¨»å†Šé–‹å§‹</a>
      <a class="button" href="{{ url_for('auth.login') }}">æˆ‘å·²æœ‰å¸³è™Ÿ</a>
    {% endif %}
  </div>
</section> -->
<form method="get" action="{{ url_for('recipes.index') }}" class="filter-bar" style="margin: 20px 0; display: flex; gap: 1em; align-items: center;">
  <!-- ğŸ·ï¸ åˆ†é¡é¸å–® -->
  <label for="category">åˆ†é¡ï¼š</label>
  <select name="category_id" id="category" onchange="this.form.submit()">
    <option value="">å…¨éƒ¨åˆ†é¡</option>
    {% for c, count in categories %}
      <option value="{{ c.id }}" {% if selected_category_id == c.id %}selected{% endif %}>
        {{ c.name }}ï¼ˆ{{ count }}ï¼‰
      </option>
    {% endfor %}
  </select>

  <!-- ğŸš« éæ•åŸç¯©é¸ -->
  <label for="allergen">éæ•åŸï¼š</label>
  <select name="allergen_id" id="allergen" onchange="this.form.submit()">
    <option value="">ç„¡ï¼ˆé¡¯ç¤ºå…¨éƒ¨ï¼‰</option>
    {% for a in allergens %}
      <option value="{{ a.id }}" {% if selected_allergen_id == a.id %}selected{% endif %}>
        {{ a.name }}
      </option>
    {% endfor %}
  </select>
</form>

<!-- <form method="get" action="{{ url_for('recipes.index') }}" class="filter-bar" style="margin: 20px 0; display: flex; gap: 1em; align-items: center;">
  <label for="category">åˆ†é¡ï¼š</label>
  <select name="category_id" id="category" onchange="this.form.submit()">
    <option value="">å…¨éƒ¨åˆ†é¡</option>
    {% for c, count in categories %}
      <option value="{{ c.id }}"  {% if request.args.get('category_id')|int == c.id %}selected{% endif %}>
        {{ c.name }}ï¼ˆ{{ count }}ï¼‰
      </option>
    {% endfor %}
  </select>

  <label for="allergen">éæ•åŸï¼š</label>
  <select name="allergen_id" id="allergen" onchange="this.form.submit()">
    <option value="">ç„¡ï¼ˆé¡¯ç¤ºå…¨éƒ¨ï¼‰</option>
    {% for a in allergens %}
      <option value="{{ a.id }}" {% if selected_allergen_id == a.id %}selected{% endif %}>
        {{ a.name }}
      </option>
    {% endfor %}
  </select>
</form> -->

<div class="cards pro">
  {% for r in recipes %}
    {% set avg = (r.reviews|map(attribute='rating')|list)|length and ((r.reviews|map(attribute='rating')|sum) / (r.reviews|length)) or 0 %}
    <article class="card hover-rise">
      <a class="thumb" href="{{ url_for('recipes.show', rid=r.id) }}">
        {{ m.cover(r.image_url, r.name) }}
      </a>
      <div class="body">
        <header>
          <h3><a href="{{ url_for('recipes.show', rid=r.id) }}">{{ r.name }}</a></h3>
          {% if r.category %}<span class="badge">{{ r.category.name }}</span>{% endif %}
        </header>
        <p class="desc">{{ r.description or 'â€”' }}</p>
        <footer>
          <span class="muted"><i class="fa-regular fa-clock"></i> {{ r.cook_time_min }} åˆ†é˜</span>
          <span class="stars">{{ m.stars(avg) }} <small>{{ '%.1f' % avg }}</small></span>
        </footer>
      </div>
    </article>
  {% else %}
    <div class="empty">
      <i class="fa-regular fa-face-smile"></i>
      <p>ç›®å‰æ²’æœ‰é£Ÿè­œï¼Œ<a href="{{ url_for('recipes.new') }}">æ–°å¢ç¬¬ä¸€å€‹</a>å§ï¼</p>
    </div>
  {% endfor %}
</div>
{% endblock %}
